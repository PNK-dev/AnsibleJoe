---
# Gestión de usuarios en AlmaLinux

- name: "Crear grupos necesarios"
  group:
    name: "{{ item }}"
    state: present
  loop:
    - wheel
    - devs
    - security
    - audit
    - profesores
    - estudiantes

- name: "Crear usuario admin (privilegios totales)"
  user:
    name: admin
    comment: "Administrador total"
    groups: wheel
    append: true
    shell: /bin/bash
    create_home: true
    password: "{{ (vault_almalinux_passwords.admin | default('Admin2025!')) | password_hash('sha512') }}"

- name: "Crear usuario tech (acceso limitado)"
  user:
    name: tech
    comment: "Operador técnico"
    groups: wheel
    append: true
    shell: /bin/bash
    create_home: true
    password: "{{ (vault_almalinux_passwords.tech | default('Tech2025!')) | password_hash('sha512') }}"

- name: "Crear usuario profesor (sin sudo)"
  user:
    name: profesor
    comment: "Profesor - sin sudo"
    groups: profesores
    append: true
    shell: /bin/bash
    create_home: true
    password: "{{ (vault_almalinux_passwords.profesor | default('Prof2025!')) | password_hash('sha512') }}"

- name: "Crear usuario estudiante (sin sudo)"
  user:
    name: estudiante
    comment: "Estudiante - sin sudo"
    groups: estudiantes
    append: true
    shell: /bin/bash
    create_home: true
    password: "{{ (vault_almalinux_passwords.estudiante | default('Est2025!')) | password_hash('sha512') }}"

- name: "Crear usuario dev (acceso medio)"
  user:
    name: dev
    comment: "Desarrollador"
    groups: devs
    append: true
    shell: /bin/bash
    create_home: true
    password: "{{ (vault_almalinux_passwords.dev | default('Dev2025!')) | password_hash('sha512') }}"

- name: "Crear usuario security (solo seguridad)"
  user:
    name: security
    comment: "Operador de seguridad"
    groups: security
    append: true
    shell: /bin/bash
    create_home: true
    password: "{{ (vault_almalinux_passwords.security | default('Sec2025!')) | password_hash('sha512') }}"

- name: "Crear usuario auditor (solo lectura, sin sudo)"
  user:
    name: auditor
    comment: "Auditor - solo lectura"
    groups: audit
    append: true
    shell: /bin/bash
    create_home: true
    password: "{{ (vault_almalinux_passwords.auditor | default('Audit2025!')) | password_hash('sha512') }}"

- name: "Sudoers para admin (full root sin contraseña)"
  copy:
    dest: /etc/sudoers.d/admin
    mode: '0440'
    content: |
      admin ALL=(ALL) NOPASSWD: ALL

- name: "Sudoers para tech (limitado)"
  copy:
    dest: /etc/sudoers.d/tech
    mode: '0440'
    content: |
      tech ALL=(ALL) NOPASSWD: \
        /usr/bin/systemctl start *, \
        /usr/bin/systemctl stop *, \
        /usr/bin/systemctl restart *, \
        /usr/bin/systemctl status *, \
        /usr/bin/journalctl *

- name: "Sudoers para dev (acceso medio a servicios y logs)"
  copy:
    dest: /etc/sudoers.d/dev
    mode: '0440'
    content: |
      dev ALL=(ALL) NOPASSWD: \
        /usr/bin/systemctl restart *, \
        /usr/bin/systemctl status *, \
        /usr/bin/journalctl *

- name: "Sudoers para security (solo herramientas de seguridad)"
  copy:
    dest: /etc/sudoers.d/security
    mode: '0440'
    content: |
      security ALL=(ALL) NOPASSWD: \
        /usr/bin/fail2ban-client *, \
        /usr/bin/firewall-cmd *, \
        /usr/sbin/ausearch *, \
        /usr/sbin/aureport *, \
        /usr/sbin/semanage *

- name: "Quitar sudo a auditor (asegurar sin permisos)"
  file:
    path: /etc/sudoers.d/auditor
    state: absent

- name: "Quitar sudo a profesor (asegurar sin permisos)"
  file:
    path: /etc/sudoers.d/profesor
    state: absent

- name: "Quitar sudo a estudiante (asegurar sin permisos)"
  file:
    path: /etc/sudoers.d/estudiante
    state: absent

- name: "Asegurar permisos 0700 en home"
  file:
    path: "/home/{{ item }}"
    mode: "0700"
  loop:
    - admin
    - tech
    - profesor
    - estudiante
    - dev
    - security
    - auditor
